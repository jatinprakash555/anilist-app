<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anilist</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    </script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #000000;
        }
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(125deg, #000000, #1f1f1f, #991b1b, #dc2626, #000000);
            background-size: 400% 400%;
            animation: gradientAnimation 25s ease infinite;
            z-index: -1;
        }
        @keyframes gradientAnimation { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .glass-card {
            background: rgba(17, 17, 17, 0.5); backdrop-filter: blur(12px);
            border: 1px solid rgba(51, 51, 51, 0.5);
            transition: all 0.4s ease; opacity: 0; transform: translateY(20px);
        }
        .glass-card.visible { opacity: 1; transform: translateY(0); }
        .glass-card.visible:hover { border-color: rgba(220, 38, 38, 0.5); transform: translateY(-5px); box-shadow: 0 20px 25px -5px rgba(0,0,0,0.2); }
        .anime-poster-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 1.5rem; }
        .tab-btn { transition: all 0.3s ease; border-bottom: 2px solid transparent; }
        .tab-btn.active { color: #f87171; border-bottom-color: #f87171; }
        .text-shadow { text-shadow: 0 2px 4px rgba(0, 0, 0, 0.6); }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; transition: background-color 0.3s ease; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        #toast-notification.show { transform: translateY(0); opacity: 1; }
    </style>
</head>
<body class="text-gray-300">
    
    <!-- Header -->
    <header class="bg-black/70 backdrop-blur-sm sticky top-0 z-40 border-b border-gray-800/50">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-4 flex items-center justify-between">
            <h1 class="text-2xl font-bold text-white flex items-center gap-2">
                <i data-lucide="clapperboard" class="text-red-500"></i>
                <span>Ani<span class="text-red-500">List</span></span>
            </h1>
            <div class="flex items-center gap-4">
                <div class="w-full sm:max-w-xs">
                    <form id="search-form" class="relative">
                        <input id="search-input" type="text" placeholder="Search..." class="w-full bg-gray-900 border border-gray-700 text-white rounded-full py-2 pl-10 pr-4 focus:outline-none focus:ring-2 focus:ring-red-500 transition">
                        <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400"></i>
                    </form>
                </div>
                <!-- Profile Dropdown -->
                <div id="profile-menu" class="relative">
                    <button id="profile-button" class="w-10 h-10 bg-gray-700 rounded-full flex items-center justify-center hover:bg-gray-600 transition">
                        <i data-lucide="user" class="h-5 w-5 text-gray-300"></i>
                    </button>
                    <div id="profile-dropdown" class="absolute right-0 mt-2 w-72 bg-gray-800 border border-gray-700 rounded-lg shadow-lg hidden origin-top-right">
                        <div class="p-4">
                            <p class="text-sm text-gray-400">Signed in as:</p>
                            <p id="user-email-display" class="text-sm text-white truncate font-semibold mt-1"></p>
                        </div>
                        <div class="border-t border-gray-700">
                            <button id="signout-btn" class="w-full text-left px-4 py-3 text-sm text-red-400 hover:bg-red-500/10 flex items-center gap-2">
                                <i data-lucide="log-out" class="h-4 w-4"></i>
                                Sign Out
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content (only shown after login) -->
    <main id="app-content" class="container mx-auto p-4 sm:p-6 lg:p-8 hidden">
        <div id="search-results-container" class="hidden">
            <div class="flex justify-between items-center mb-6"><h2 class="text-3xl font-bold text-white">Search Results</h2><button id="clear-search-btn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg flex items-center gap-2 transition"><i data-lucide="arrow-left" class="h-4 w-4"></i> Back to My Lists</button></div>
            <div id="search-results" class="anime-poster-grid"></div>
        </div>
        <div id="lists-container">
            <section class="text-center mb-12"><h2 class="text-4xl md:text-5xl font-bold text-white text-shadow">Your Personal Anime Hub</h2><p class="text-gray-200 mt-4 max-w-2xl mx-auto text-shadow">Track what you're planning, watching, and have completed, all in one place.</p></section>
            <div class="border-b border-gray-700 mb-8"><nav class="-mb-px flex justify-center space-x-8" aria-label="Tabs"><button class="tab-btn active whitespace-nowrap py-4 px-1 text-base font-medium" data-tab="planning">Planning</button><button class="tab-btn whitespace-nowrap py-4 px-1 text-base font-medium text-gray-200 hover:text-white" data-tab="watching">Watching</button><button class="tab-btn whitespace-nowrap py-4 px-1 text-base font-medium text-gray-200 hover:text-white" data-tab="completed">Completed</button></nav></div>
            <div id="planning-tab" class="tab-content"><div class="bg-black/20 p-6 rounded-lg min-h-[400px]"><div id="planning-list" class="anime-poster-grid"></div></div></div>
            <div id="watching-tab" class="tab-content hidden"><div class="bg-black/20 p-6 rounded-lg min-h-[400px]"><div id="watching-list" class="anime-poster-grid"></div></div></div>
            <div id="completed-tab" class="tab-content hidden"><div class="bg-black/20 p-6 rounded-lg min-h-[400px]"><div id="completed-list" class="anime-poster-grid"></div></div></div>
        </div>
    </main>

    <!-- App loading state -->
    <div id="loading-state" class="text-center py-20"><p class="text-gray-400">Authenticating...</p></div>

    <!-- Modals & Toast -->
    <div id="details-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden glass-card bg-black/50"><div class="glass-card rounded-lg shadow-2xl w-full max-w-3xl max-h-[90vh] flex flex-col overflow-hidden border-red-500/20"><div id="modal-content" class="p-6 overflow-y-auto"></div><div id="modal-footer" class="p-4 bg-black/50 mt-auto border-t border-gray-800/50"></div></div></div>
    <div id="note-modal" class="fixed inset-0 z-[60] flex items-center justify-center p-4 hidden glass-card bg-black/50"><div class="glass-card rounded-lg shadow-2xl w-full max-w-md border-red-500/20"><h3 class="text-lg font-semibold p-4 border-b border-gray-700 text-white">Edit Note</h3><div class="p-4"><textarea id="note-input" class="w-full bg-gray-800 border border-gray-700 rounded-md p-2 text-white" rows="4" placeholder="Add a note or paste a hianime.to link..."></textarea></div><div class="p-4 bg-black/50 flex justify-end gap-4"><button id="cancel-note-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg">Cancel</button><button id="save-note-btn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg">Save</button></div></div></div>
    <div id="toast-notification" class="fixed bottom-5 right-5 bg-red-600 text-white py-3 px-5 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-500 ease-in-out z-[100]"><p></p></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firestore.js";
        
        document.addEventListener('DOMContentLoaded', () => {
            const allDOMElements = {
                loadingState: document.getElementById('loading-state'), appContent: document.getElementById('app-content'), searchForm: document.getElementById('search-form'), searchInput: document.getElementById('search-input'), searchResultsContainer: document.getElementById('search-results-container'), searchResultsDiv: document.getElementById('search-results'), clearSearchBtn: document.getElementById('clear-search-btn'), listsContainer: document.getElementById('lists-container'), detailsModal: document.getElementById('details-modal'), modalContent: document.getElementById('modal-content'), modalFooter: document.getElementById('modal-footer'), noteModal: document.getElementById('note-modal'), noteInput: document.getElementById('note-input'), saveNoteBtn: document.getElementById('save-note-btn'), cancelNoteBtn: document.getElementById('cancel-note-btn'), toastNotification: document.getElementById('toast-notification'), tabs: document.querySelectorAll('.tab-btn'), tabContents: document.querySelectorAll('.tab-content'), profileMenu: document.getElementById('profile-menu'), profileButton: document.getElementById('profile-button'), profileDropdown: document.getElementById('profile-dropdown'), userEmailDisplay: document.getElementById('user-email-display'), signOutBtn: document.getElementById('signout-btn'),
            };
            
            let currentUser = null, db, auth, unsubscribe;
            let currentNoteEdit = { animeId: null, listKey: null }, currentModalAnime = null;
            let lists = { planning: [], watching: [], completed: [] };

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id-anilist';
            const firebaseConfigString = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
            let firebaseConfig = {};
            try { firebaseConfig = JSON.parse(firebaseConfigString); } catch(e) { console.error("Firebase config error"); }
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            onAuthStateChanged(auth, user => {
                if (user) {
                    currentUser = user;
                    allDOMElements.loadingState.classList.add('hidden');
                    allDOMElements.appContent.classList.remove('hidden');
                    allDOMElements.userEmailDisplay.textContent = user.isAnonymous ? 'Anonymous User' : user.email;
                    listenToData();
                } else {
                    const newPath = window.location.pathname.replace('anime-watchlist.html', 'login.html');
                    window.location.href = newPath;
                }
            });

            allDOMElements.signOutBtn.addEventListener('click', () => { signOut(auth).catch(error => console.error("Sign out error", error)); });

            function listenToData() {
                if (unsubscribe) unsubscribe();
                const userDocRef = doc(db, "artifacts", appId, "users", currentUser.uid);
                unsubscribe = onSnapshot(userDocRef, (docSnap) => {
                    if (docSnap.exists()) { lists = docSnap.data().watchlist || { planning: [], watching: [], completed: [] }; }
                    else { lists = { planning: [], watching: [], completed: [] }; setDoc(userDocRef, { watchlist: lists }); }
                    renderAllLists();
                    checkForNewEpisodes();
                }, (error) => { console.error("Firestore snapshot error:", error); });
            }

            async function saveData() {
                if (!currentUser) return;
                const userDocRef = doc(db, "artifacts", appId, "users", currentUser.uid);
                await setDoc(userDocRef, { watchlist: lists });
            }
            
            const observer = new IntersectionObserver((entries) => { entries.forEach(entry => { if (entry.isIntersecting) { entry.target.classList.add('visible'); observer.unobserve(entry.target); } }); }, { threshold: 0.1 });
            const API_BASE_URL = 'https://api.jikan.moe/v4';

            function debounce(func, delay) { let timeout; return (...args) => { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), delay); }; }
            
            async function searchAnime(query) {
                if (!query || query.length < 3) { allDOMElements.searchResultsContainer.classList.add('hidden'); allDOMElements.listsContainer.classList.remove('hidden'); return; }
                allDOMElements.searchResultsDiv.innerHTML = `<p class="text-gray-400 col-span-full">Searching...</p>`;
                allDOMElements.searchResultsContainer.classList.remove('hidden'); allDOMElements.listsContainer.classList.add('hidden');
                try {
                    const response = await fetch(`${API_BASE_URL}/anime?q=${encodeURIComponent(query)}&sfw`);
                    if (!response.ok) throw new Error('Network response was not ok');
                    const data = await response.json();
                    displaySearchResults(data.data);
                } catch (error) { console.error('Failed to fetch anime:', error); allDOMElements.searchResultsDiv.innerHTML = `<p class="text-red-400 col-span-full">Could not fetch results.</p>`; }
            }
            
            function displaySearchResults(results) {
                allDOMElements.searchResultsDiv.innerHTML = '';
                if (!results || results.length === 0) { allDOMElements.searchResultsDiv.innerHTML = `<p class="text-gray-400 col-span-full">No results found.</p>`; }
                else { results.slice(0, 18).forEach(anime => { const card = createAnimeCard(anime, 'search'); allDOMElements.searchResultsDiv.appendChild(card); observer.observe(card); }); }
                lucide.createIcons();
            }

            function createAnimeCard(anime, context) {
                const div = document.createElement('div');
                div.className = 'glass-card rounded-lg overflow-hidden shadow-lg flex flex-col relative cursor-pointer group';
                div.dataset.animeId = anime.mal_id;
                const score = anime.score ? `<span class="font-bold text-yellow-400">${anime.score.toFixed(1)}</span>` : 'N/A';
                const notificationDot = anime.hasNewEpisode ? `<div class="absolute top-2 right-2 bg-red-500 rounded-full w-4 h-4 border-2 border-gray-900 animate-pulse" title="New episode available!"></div>` : '';
                div.innerHTML = `<div class="relative"><img src="${anime.images.jpg.large_image_url}" alt="${anime.title}" class="w-full h-64 object-cover"><div class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent"></div><div class="absolute bottom-0 left-0 p-3"><h3 class="font-semibold text-sm text-white truncate">${anime.title}</h3><p class="text-xs text-yellow-300">⭐ ${score}</p></div>${notificationDot}</div>`;
                const controls = document.createElement('div');
                controls.className = 'absolute inset-0 bg-black/70 flex flex-col items-center justify-center p-2 opacity-0 group-hover:opacity-100 transition-opacity duration-300';
                if (context === 'search') {
                    const allAnimeInLists = Object.values(lists).flatMap(list => list || []);
                    const existingAnime = allAnimeInLists.find(item => item.mal_id === anime.mal_id);
                    let watchButtonHTML = '';
                    if (existingAnime && existingAnime.note) { watchButtonHTML = `<a href="${existingAnime.note}" target="_blank" class="watch-btn text-center text-sm bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-3 rounded-lg w-full">Continue</a>`; }
                    else { const hianimeQuery = encodeURIComponent(anime.title); watchButtonHTML = `<a href="https://hianime.to/search?keyword=${hianimeQuery}" target="_blank" class="watch-btn text-center text-sm bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-3 rounded-lg w-full">Search</a>`; }
                    controls.innerHTML = `<button class="details-btn text-sm bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-3 rounded-lg w-full mb-2">Details</button>${watchButtonHTML}`;
                } else {
                    controls.innerHTML = `<button class="details-btn text-sm bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-3 rounded-lg w-full">Manage</button>`;
                    if (anime.note) controls.innerHTML += `<a href="${anime.note}" target="_blank" class="mt-2 text-center text-sm bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-3 rounded-lg w-full">Watch</a>`;
                }
                div.appendChild(controls);
                div.querySelector('.details-btn').addEventListener('click', () => showDetailsModal(anime));
                return div;
            }

            function renderAllLists() { ['planning', 'watching', 'completed'].forEach(key => renderList(key)); lucide.createIcons(); }
            function renderList(listKey) {
                const listEl = document.getElementById(`${listKey}-list`);
                listEl.innerHTML = '';
                const currentList = lists[listKey] || [];
                if (currentList.length === 0) { listEl.innerHTML = `<p class="text-center text-gray-400 mt-8 col-span-full text-shadow">This list is empty. Use the search bar to find and add anime.</p>`; }
                else { currentList.forEach(anime => { const card = createAnimeCard(anime, listKey); listEl.appendChild(card); observer.observe(card); }); }
            }
            
            async function showDetailsModal(animeData) {
                currentModalAnime = animeData;
                const fullAnimeData = await getFullAnimeDetails(animeData.mal_id);
                const anime = fullAnimeData || animeData;
                currentModalAnime = anime;
                allDOMElements.modalContent.innerHTML = `<div class="flex flex-col sm:flex-row gap-6"><img src="${anime.images.jpg.large_image_url}" alt="${anime.title}" class="w-full sm:w-1/3 h-auto object-cover rounded-lg shadow-lg"><div class="flex-1"><h2 class="text-3xl font-bold mb-2 text-white text-shadow">${anime.title}</h2><p class="text-sm text-gray-300 mb-4 text-shadow">${anime.title_japanese || ''}</p><div class="flex flex-wrap gap-2 mb-4">${(anime.genres || []).map(g => `<span class="bg-red-900/50 text-red-300 text-xs font-semibold px-2 py-1 rounded-full">${g.name}</span>`).join('')}</div><p class="text-sm text-gray-200 max-h-48 overflow-y-auto pr-2 text-shadow">${anime.synopsis || 'No synopsis available.'}</p><div class="mt-4 pt-4 border-t border-gray-700 text-sm grid grid-cols-2 gap-2"><p><strong>Score:</strong> ⭐ ${anime.score ? anime.score.toFixed(2) : 'N/A'}</p><p><strong>Rank:</strong> #${anime.rank || 'N/A'}</p><p><strong>Episodes:</strong> ${anime.episodes || 'TBA'}</p><p><strong>Status:</strong> ${anime.status || 'N/A'}</p></div></div></div>`;
                showAppropriateControls(anime);
                allDOMElements.detailsModal.classList.remove('hidden');
            }

            function showAppropriateControls(anime) {
                const allAnimeInLists = Object.values(lists).flatMap(list => list || []);
                const existingAnime = allAnimeInLists.find(item => item.mal_id === anime.mal_id);
                if (existingAnime) {
                    const currentListKey = Object.keys(lists).find(key => lists[key] && lists[key].some(a => a.mal_id === anime.mal_id));
                    showManageControls(existingAnime, currentListKey);
                } else {
                    showAddControls();
                }
            }

            function showAddControls() {
                allDOMElements.modalFooter.innerHTML = `<div class="w-full flex justify-between items-center gap-4"><div class="flex-1 flex justify-start gap-2 flex-wrap"><button class="add-btn bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-3 rounded-lg text-sm" data-list="planning">Add to Planning</button><button class="add-btn bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-3 rounded-lg text-sm" data-list="watching">Add to Watching</button><button class="add-btn bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-3 rounded-lg text-sm" data-list="completed">Add to Completed</button></div><button id="close-modal-btn" class="bg-gray-700 hover:bg-gray-800 text-white font-semibold py-2 px-4 rounded-lg">Close</button></div>`;
            }

            function showManageControls(anime, currentListKey) {
                allDOMElements.modalFooter.innerHTML = `<div class="w-full flex justify-between items-center gap-4"><div class="flex items-center gap-2"><span class="text-sm text-gray-400">On '${currentListKey}' list</span><button class="edit-note-btn text-gray-400 hover:text-white p-2 rounded-lg bg-gray-700 hover:bg-gray-600" title="Edit Note"><i data-lucide="file-pen-line" class="w-4 h-4"></i></button></div><div><button class="remove-btn text-red-400 hover:text-red-300 font-semibold py-2 px-4 rounded-lg bg-red-900/50 hover:bg-red-900/80">Remove</button><button id="close-modal-btn" class="bg-gray-700 hover:bg-gray-800 text-white font-semibold py-2 px-4 rounded-lg ml-2">Close</button></div></div>`;
                lucide.createIcons();
                allDOMElements.modalFooter.querySelector('.edit-note-btn').addEventListener('click', () => openNoteModal(anime.mal_id, currentListKey));
                allDOMElements.modalFooter.querySelector('.remove-btn').addEventListener('click', () => { removeAnime(anime.mal_id, currentListKey); allDOMElements.detailsModal.classList.add('hidden'); });
            }
            
            async function getFullAnimeDetails(id) {
                try {
                    const response = await fetch(`${API_BASE_URL}/anime/${id}/full`);
                    if (!response.ok) return null;
                    const { data } = await response.json();
                    return data;
                } catch (error) { console.error('Failed to fetch full anime details:', error); return null; }
            }

            function addAnime(anime, listKey) {
                const allAnimeInLists = Object.values(lists).flatMap(list => list || []);
                if (allAnimeInLists.some(item => item && item.mal_id === anime.mal_id)) {
                    showToast(`${anime.title} is already in a list.`, 'error');
                    return false;
                }
                if (!lists[listKey]) lists[listKey] = [];
                lists[listKey].unshift({ ...anime, note: '' });
                saveData();
                showToast(`Added to ${listKey}!`, 'success');
                return true;
            }

            function removeAnime(animeId, listKey) {
                if (confirm('Are you sure you want to remove this anime?')) {
                    if(lists[listKey]) {
                        lists[listKey] = lists[listKey].filter(a => a.mal_id !== animeId);
                        saveData();
                    }
                }
            }
            
            function openNoteModal(animeId, listKey) {
                currentNoteEdit = { animeId, listKey };
                const anime = lists[listKey].find(a => a.mal_id === animeId);
                allDOMElements.noteInput.value = anime?.note || '';
                allDOMElements.noteModal.classList.remove('hidden');
            }

            function saveNote() {
                const { animeId, listKey } = currentNoteEdit;
                const anime = lists[listKey].find(a => a.mal_id === animeId);
                if (anime) {
                    const noteText = allDOMElements.noteInput.value.trim();
                    if (noteText === '') { anime.note = ''; } 
                    else {
                        let isUrl = false;
                        try { const url = new URL(noteText); if (url.hostname.includes('hianime.to')) isUrl = true; } catch (_) {}
                        if (isUrl) { anime.note = noteText; showToast('Watch link saved!', 'success');
                        } else if (noteText.startsWith('https://') || noteText.startsWith('http://')) {
                            showToast('Invalid link. Please only use hianime.to links.', 'error'); return;
                        } else { anime.note = noteText; showToast('Note saved!', 'success'); }
                    }
                    saveData();
                    allDOMElements.noteModal.classList.add('hidden');
                }
            }
            
            async function checkForNewEpisodes() { /* Unchanged */ }
            function showToast(message, type = 'info') {
                allDOMElements.toastNotification.querySelector('p').textContent = message;
                allDOMElements.toastNotification.className = allDOMElements.toastNotification.className.replace(/bg-(red|yellow)-600/, `bg-${type === 'error' ? 'yellow' : 'red'}-600`);
                allDOMElements.toastNotification.classList.add('show');
                setTimeout(() => { allDOMElements.toastNotification.classList.remove('show'); }, 4000);
            }

            // --- Event Listeners ---
            const debouncedSearch = debounce(searchAnime, 500);
            allDOMElements.searchForm.addEventListener('submit', e => { e.preventDefault(); searchAnime(allDOMElements.searchInput.value); });
            allDOMElements.searchInput.addEventListener('input', e => debouncedSearch(e.target.value));
            allDOMElements.clearSearchBtn.addEventListener('click', () => { allDOMElements.searchInput.value = ''; allDOMElements.searchResultsContainer.classList.add('hidden'); allDOMElements.listsContainer.classList.remove('hidden'); });
            allDOMElements.detailsModal.addEventListener('click', e => { if (e.target === allDOMElements.detailsModal) allDOMElements.detailsModal.classList.add('hidden'); });
            allDOMElements.modalFooter.addEventListener('click', e => {
                const button = e.target.closest('button');
                if (!button) return;
                if (button.id === 'close-modal-btn') allDOMElements.detailsModal.classList.add('hidden');
                if (button.classList.contains('add-btn')) {
                    const listKey = button.dataset.list;
                    if (currentModalAnime && addAnime(currentModalAnime, listKey)) {
                        showAppropriateControls(currentModalAnime, listKey);
                    }
                }
            });
            allDOMElements.tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    allDOMElements.tabs.forEach(t => { t.classList.remove('active', 'text-red-400'); t.classList.add('text-gray-200'); });
                    tab.classList.add('active', 'text-red-400');
                    tab.classList.remove('text-gray-200');
                    allDOMElements.tabContents.forEach(content => content.classList.add('hidden'));
                    document.getElementById(tab.dataset.tab + '-tab').classList.remove('hidden');
                });
            });
            allDOMElements.saveNoteBtn.addEventListener('click', saveNote);
            allDOMElements.cancelNoteBtn.addEventListener('click', () => allDOMElements.noteModal.classList.add('hidden'));
            allDOMElements.noteModal.addEventListener('click', e => { if (e.target === allDOMElements.noteModal) allDOMElements.noteModal.classList.add('hidden'); });
            
            allDOMElements.profileButton.addEventListener('click', () => allDOMElements.profileDropdown.classList.toggle('hidden'));
            
            document.addEventListener('click', (e) => {
                if (allDOMElements.profileMenu && !allDOMElements.profileMenu.contains(e.target)) {
                    allDOMElements.profileDropdown.classList.add('hidden');
                }
            });
            lucide.createIcons();
        });
    </script>
</body>
</html>

