<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anilist</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    </script>
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #000000; }
        body::before { content: ''; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(125deg, #000000, #1f1f1f, #991b1b, #dc2626, #000000); background-size: 400% 400%; animation: gradientAnimation 25s ease infinite; z-index: -1; }
        @keyframes gradientAnimation { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .glass-card { background: rgba(17, 17, 17, 0.5); backdrop-filter: blur(12px); border: 1px solid rgba(51, 51, 51, 0.5); transition: all 0.4s ease; opacity: 0; transform: translateY(20px); }
        .glass-card.visible { opacity: 1; transform: translateY(0); }
        .glass-card.visible:hover { border-color: rgba(220, 38, 38, 0.5); transform: translateY(-5px); box-shadow: 0 20px 25px -5px rgba(0,0,0,0.2); }
        .anime-poster-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 1.5rem; }
        .tab-btn { transition: all 0.3s ease; border-bottom: 2px solid transparent; }
        .tab-btn.active { color: #f87171; border-bottom-color: #f87171; }
        .text-shadow { text-shadow: 0 2px 4px rgba(0, 0, 0, 0.6); }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; transition: background-color 0.3s ease; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        #toast-notification.show { transform: translateY(0); opacity: 1; }
    </style>
</head>
<body class="text-gray-300">
    
    <!-- Header -->
    <header class="bg-black/70 backdrop-blur-sm sticky top-0 z-40 border-b border-gray-800/50">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-4 flex items-center justify-between">
            <h1 class="text-2xl font-bold text-white flex items-center gap-2">
                <i data-lucide="clapperboard" class="text-red-500"></i>
                <span>Ani<span class="text-red-500">List</span></span>
            </h1>
            <div class="flex items-center gap-4">
                <div class="w-full sm:max-w-xs">
                    <form id="search-form" class="relative">
                        <input id="search-input" type="text" placeholder="Search..." class="w-full bg-gray-900 border border-gray-700 text-white rounded-full py-2 pl-10 pr-4 focus:outline-none focus:ring-2 focus:ring-red-500 transition">
                        <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400"></i>
                    </form>
                </div>
                <div id="profile-menu" class="relative">
                    <button id="profile-button" class="w-10 h-10 bg-gray-700 rounded-full flex items-center justify-center hover:bg-gray-600 transition"><i data-lucide="user" class="h-5 w-5 text-gray-300"></i></button>
                    <div id="profile-dropdown" class="absolute right-0 mt-2 w-72 bg-gray-800 border border-gray-700 rounded-lg shadow-lg hidden origin-top-right">
                        <div class="p-4"><p class="text-sm text-gray-400">Signed in as:</p><p id="user-email-display" class="text-sm text-white truncate font-semibold mt-1"></p></div>
                        <div class="border-t border-gray-700"><button id="signout-btn" class="w-full text-left px-4 py-3 text-sm text-red-400 hover:bg-red-500/10 flex items-center gap-2"><i data-lucide="log-out" class="h-4 w-4"></i>Sign Out</button></div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main id="app-content" class="container mx-auto p-4 sm:p-6 lg:p-8 hidden">
        <div id="search-results-container" class="hidden">
            <div class="flex justify-between items-center mb-6"><h2 class="text-3xl font-bold text-white">Search Results</h2><button id="clear-search-btn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg flex items-center gap-2 transition"><i data-lucide="arrow-left" class="h-4 w-4"></i> Back to My Lists</button></div>
            <div id="search-results" class="anime-poster-grid"></div>
        </div>
        <div id="lists-container">
            <section class="text-center mb-12"><h2 class="text-4xl md:text-5xl font-bold text-white text-shadow">Your Personal Anime Hub</h2><p class="text-gray-200 mt-4 max-w-2xl mx-auto text-shadow">Track what you're planning, watching, and have completed, all in one place.</p></section>
            <div class="border-b border-gray-700 mb-8"><nav class="-mb-px flex justify-center space-x-8"><button class="tab-btn active" data-tab="planning">Planning</button><button class="tab-btn" data-tab="watching">Watching</button><button class="tab-btn" data-tab="completed">Completed</button></nav></div>
            <div id="planning-tab" class="tab-content"><div class="bg-black/20 p-6 rounded-lg min-h-[400px]"><div id="planning-list" class="anime-poster-grid"></div></div></div>
            <div id="watching-tab" class="tab-content hidden"><div class="bg-black/20 p-6 rounded-lg min-h-[400px]"><div id="watching-list" class="anime-poster-grid"></div></div></div>
            <div id="completed-tab" class="tab-content hidden"><div class="bg-black/20 p-6 rounded-lg min-h-[400px]"><div id="completed-list" class="anime-poster-grid"></div></div></div>
        </div>
    </main>

    <div id="loading-state" class="text-center py-20"><p class="text-gray-400">Authenticating...</p></div>
    <div id="details-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden"><div class="glass-card rounded-lg shadow-2xl w-full max-w-3xl max-h-[90vh] flex flex-col"><div id="modal-content" class="p-6 overflow-y-auto"></div><div id="modal-footer" class="p-4 bg-black/50 mt-auto border-t"></div></div></div>
    <div id="note-modal" class="fixed inset-0 z-[60] flex items-center justify-center p-4 hidden"><div class="glass-card rounded-lg shadow-2xl w-full max-w-md"><h3 class="p-4 border-b">Edit Note</h3><div class="p-4"><textarea id="note-input" rows="4"></textarea></div><div class="p-4 flex justify-end gap-4"><button id="cancel-note-btn">Cancel</button><button id="save-note-btn">Save</button></div></div></div>
    <div id="toast-notification" class="fixed bottom-5 right-5 z-[100]"><p></p></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firestore.js";
        
        const firebaseConfig = {
          apiKey: "AIzaSyBBqEu81eWcRDbDF-4pehrI9yOu4fIP_ps",
          authDomain: "anilist-34804.firebaseapp.com",
          projectId: "anilist-34804",
          storageBucket: "anilist-34804.firebasestorage.app",
          messagingSenderId: "313389648813",
          appId: "1:313389648813:web:815535b3b0b17e71d9ef24",
        };

        document.addEventListener('DOMContentLoaded', () => {
            const allDOMElements = {
                loadingState: document.getElementById('loading-state'), appContent: document.getElementById('app-content'), searchForm: document.getElementById('search-form'), searchInput: document.getElementById('search-input'), searchResultsContainer: document.getElementById('search-results-container'), searchResultsDiv: document.getElementById('search-results'), clearSearchBtn: document.getElementById('clear-search-btn'), listsContainer: document.getElementById('lists-container'), detailsModal: document.getElementById('details-modal'), modalContent: document.getElementById('modal-content'), modalFooter: document.getElementById('modal-footer'), noteModal: document.getElementById('note-modal'), noteInput: document.getElementById('note-input'), saveNoteBtn: document.getElementById('save-note-btn'), cancelNoteBtn: document.getElementById('cancel-note-btn'), toastNotification: document.getElementById('toast-notification'), tabs: document.querySelectorAll('.tab-btn'), tabContents: document.querySelectorAll('.tab-content'), profileMenu: document.getElementById('profile-menu'), profileButton: document.getElementById('profile-button'), profileDropdown: document.getElementById('profile-dropdown'), userEmailDisplay: document.getElementById('user-email-display'), signOutBtn: document.getElementById('signout-btn'),
            };
            
            let currentUser = null, db, auth, unsubscribe;
            let currentNoteEdit = {}, currentModalAnime = null;
            let lists = { planning: [], watching: [], completed: [] };

            const appId = 'default-app-id-anilist';
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            onAuthStateChanged(auth, user => {
                if (user) {
                    currentUser = user;
                    allDOMElements.loadingState.classList.add('hidden');
                    allDOMElements.appContent.classList.remove('hidden');
                    allDOMElements.userEmailDisplay.textContent = user.isAnonymous ? 'Anonymous' : user.email;
                    listenToData();
                } else {
                    const pathSegments = window.location.pathname.split('/');
                    pathSegments.pop(); // Remove the current file name
                    const redirectPath = pathSegments.join('/') + '/index.html';
                    window.location.replace(redirectPath);
                }
            });
            
            allDOMElements.signOutBtn.addEventListener('click', () => { signOut(auth).catch(error => console.error("Sign out error", error)); });

            function listenToData() {
                if (unsubscribe) unsubscribe();
                const userDocRef = doc(db, "artifacts", appId, "users", currentUser.uid);
                unsubscribe = onSnapshot(userDocRef, (docSnap) => {
                    if (docSnap.exists()) { lists = docSnap.data().watchlist || { planning: [], watching: [], completed: [] }; }
                    else { lists = { planning: [], watching: [], completed: [] }; setDoc(userDocRef, { watchlist: lists }); }
                    renderAllLists();
                    // checkForNewEpisodes(); // This function can be re-enabled if desired
                }, (error) => { console.error("Firestore snapshot error:", error); });
            }

            async function saveData() {
                if (!currentUser) return;
                const userDocRef = doc(db, "artifacts", appId, "users", currentUser.uid);
                await setDoc(userDocRef, { watchlist: lists });
            }

            const observer = new IntersectionObserver((entries) => { entries.forEach(entry => { if (entry.isIntersecting) { entry.target.classList.add('visible'); observer.unobserve(entry.target); } }); }, { threshold: 0.1 });
            const API_BASE_URL = 'https://api.jikan.moe/v4';

            function debounce(func, delay) { let timeout; return (...args) => { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), delay); }; }
            
            async function searchAnime(query) {
                if (!query || query.length < 3) { allDOMElements.searchResultsContainer.classList.add('hidden'); allDOMElements.listsContainer.classList.remove('hidden'); return; }
                allDOMElements.searchResultsDiv.innerHTML = `<p class="text-gray-400 col-span-full">Searching...</p>`;
                allDOMElements.searchResultsContainer.classList.remove('hidden'); allDOMElements.listsContainer.classList.add('hidden');
                try {
                    const response = await fetch(`${API_BASE_URL}/anime?q=${encodeURIComponent(query)}&sfw`);
                    if (!response.ok) throw new Error('Network response was not ok');
                    const data = await response.json();
                    displaySearchResults(data.data);
                } catch (error) { console.error('Failed to fetch anime:', error); allDOMElements.searchResultsDiv.innerHTML = `<p class="text-red-400 col-span-full">Could not fetch results.</p>`; }
            }

            function displaySearchResults(results) { /* ... Unchanged ... */ }
            function createAnimeCard(anime, context) { /* ... Unchanged ... */ }
            function renderAllLists() { /* ... Unchanged ... */ }
            function renderList(listKey) { /* ... Unchanged ... */ }
            async function showDetailsModal(animeData) { /* ... Unchanged ... */ }
            function showAppropriateControls(anime) { /* ... Unchanged ... */ }
            function showAddControls() { /* ... Unchanged ... */ }
            function showManageControls(anime, currentListKey) { /* ... Unchanged ... */ }
            async function getFullAnimeDetails(id) { /* ... Unchanged ... */ }
            function addAnime(anime, listKey) { /* ... Unchanged ... */ }
            function removeAnime(animeId, listKey) { /* ... Unchanged ... */ }
            function openNoteModal(animeId, listKey) { /* ... Unchanged ... */ }
            function saveNote() { /* ... Unchanged ... */ }
            // function checkForNewEpisodes() { /* ... Can be re-enabled ... */ }
            function showToast(message, type = 'info') { /* ... Unchanged ... */ }
            
            // --- Event Listeners ---
            const debouncedSearch = debounce(searchAnime, 500);
            allDOMElements.searchForm.addEventListener('submit', e => { e.preventDefault(); searchAnime(allDOMElements.searchInput.value); });
            allDOMElements.searchInput.addEventListener('input', e => debouncedSearch(e.target.value));
            allDOMElements.clearSearchBtn.addEventListener('click', () => { allDOMElements.searchInput.value = ''; allDOMElements.searchResultsContainer.classList.add('hidden'); allDOMElements.listsContainer.classList.remove('hidden'); });
            allDOMElements.detailsModal.addEventListener('click', e => { if (e.target === allDOMElements.detailsModal) allDOMElements.detailsModal.classList.add('hidden'); });
            allDOMElements.modalFooter.addEventListener('click', e => { const button = e.target.closest('button'); if (!button) return; if (button.id === 'close-modal-btn') allDOMElements.detailsModal.classList.add('hidden'); if (button.classList.contains('add-btn')) { const listKey = button.dataset.list; if (currentModalAnime && addAnime(currentModalAnime, listKey)) { showAppropriateControls(currentModalAnime, listKey); } } });
            allDOMElements.tabs.forEach(tab => { tab.addEventListener('click', () => { allDOMElements.tabs.forEach(t => { t.classList.remove('active', 'text-red-400'); t.classList.add('text-gray-200'); }); tab.classList.add('active', 'text-red-400'); tab.classList.remove('text-gray-200'); allDOMElements.tabContents.forEach(content => content.classList.add('hidden')); document.getElementById(tab.dataset.tab + '-tab').classList.remove('hidden'); }); });
            allDOMElements.saveNoteBtn.addEventListener('click', saveNote);
            allDOMElements.cancelNoteBtn.addEventListener('click', () => allDOMElements.noteModal.classList.add('hidden'));
            allDOMElements.noteModal.addEventListener('click', e => { if (e.target === allDOMElements.noteModal) allDOMElements.noteModal.classList.add('hidden'); });
            allDOMElements.profileButton.addEventListener('click', () => allDOMElements.profileDropdown.classList.toggle('hidden'));
            document.addEventListener('click', (e) => { if (allDOMElements.profileMenu && !allDOMElements.profileMenu.contains(e.target)) { allDOMElements.profileDropdown.classList.add('hidden'); } });
            lucide.createIcons();
        });
    </script>
</body>
</html>

